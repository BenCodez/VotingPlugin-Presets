<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VotingPlugin Presets</title>

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 18px;
    }
    header { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    input, select, button, textarea {
      padding: 8px 10px;
      font-size: 14px;
    }
    textarea { resize: vertical; }
    button { cursor: pointer; }
    .muted { color:#666; }
    .error { color:#b00020; }
    .layout {
      display:grid;
      grid-template-columns: 1.1fr 1fr;
      gap:14px;
      margin-top:14px;
    }
    .card {
      border:1px solid #e6e6e6;
      border-radius:12px;
      padding:12px;
      background:#fff;
    }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pill {
      display:inline-block;
      padding:2px 8px;
      border:1px solid #ddd;
      border-radius:999px;
      font-size:12px;
    }
    code {
      background:#f5f5f5;
      padding:2px 6px;
      border-radius:6px;
    }
    pre {
      background:#0b1020;
      color:#d6e1ff;
      padding:12px;
      border-radius:10px;
      overflow:auto;
      max-height:520px;
    }
    table { width:100%; border-collapse: collapse; }
    th, td {
      border-bottom:1px solid #eee;
      padding:8px;
      text-align:left;
      vertical-align:top;
    }
    th {
      background:#fafafa;
      position: sticky;
      top: 0;
    }
    .split {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .list { max-height:420px; overflow:auto; }
    .selected { outline:2px solid #3b82f6; border-radius:8px; }
    label { display:flex; flex-direction:column; gap:4px; }
  </style>
</head>

<body>

<header>
  <h2 style="margin:0;">VotingPlugin Presets</h2>

  <label class="small">
    <span class="muted">Registry base URL</span>
    <input id="baseUrl" size="48" />
  </label>

  <button id="reloadBtn">Reload</button>
  <span id="status" class="muted"></span>
</header>

<div class="row" style="margin-top:10px;">
  <input id="q" size="34" placeholder="Search presets..." />
  <select id="cat">
    <option value="">All</option>
    <option value="votesites">VoteSites</option>
    <option value="rewards">Rewards</option>
    <option value="milestones">VoteMilestones</option>
  </select>
  <span class="muted" id="count"></span>
</div>

<div id="msg" class="error" style="margin-top:10px;"></div>

<div class="layout">

  <!-- LEFT -->
  <div class="card">
    <div class="pill">Presets</div>
    <div class="list" style="margin-top:8px;">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Category</th>
            <th>Name</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div class="pill">Merged YAML</div>
        <div id="selTitle" class="muted" style="margin-top:4px;">None</div>
      </div>
      <button id="copyBtn" disabled>Copy</button>
    </div>

    <hr style="border:none;border-top:1px solid #eee;margin:10px 0;" />

    <div class="split">
      <div>
        <div class="pill">Placeholders</div>
        <div id="placeholderForm" style="margin-top:8px;"></div>
      </div>

      <div>
        <div class="pill">Add reward examples</div>
        <select id="addonRewards" multiple size="8" style="width:100%; margin-top:8px;"></select>
      </div>
    </div>

    <pre id="mergedOut" style="margin-top:10px;">Select a preset.</pre>
  </div>

</div>

<script>
/* ---------------- helpers ---------------- */

function normalizeBaseUrl(url) {
  let u = (url || "").trim();
  if (!u.endsWith("/")) u += "/";
  return u;
}

function toYamlListBlock(multiline, indentSpaces) {
  const pad = " ".repeat(indentSpaces);
  const lines = String(multiline || "")
    .split(/\r?\n/)
    .map(s => s.trim())
    .filter(s => s.length > 0);

  if (!lines.length) return pad + "- \"\"";

  return lines.map(l => `${pad}- "${l.replaceAll('"', '\\"')}"`).join("\n");
}

function applyPlaceholders(text, values) {
  let out = text;
  for (const [k, v] of Object.entries(values)) {
    out = out.split(`<${k}>`).join(String(v));
  }
  return out;
}

function sectionWrap(name, content) {
  return `${name}:\n${content.split("\n").map(l => "  " + l).join("\n")}`;
}

/* ---------------- state ---------------- */

let indexData = null;
let selected = null;
let selectedMeta = null;
let rewardEntries = [];
let placeholderValues = {};

const elBase = document.getElementById("baseUrl");
const elRows = document.getElementById("rows");
const elMerged = document.getElementById("mergedOut");
const elCopy = document.getElementById("copyBtn");
const elSelTitle = document.getElementById("selTitle");
const elForm = document.getElementById("placeholderForm");
const elAddRewards = document.getElementById("addonRewards");

/* ---------------- load index ---------------- */

(function initBase() {
  elBase.value = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, "/");
})();

async function loadIndex() {
  elMerged.textContent = "Loading...";
  const base = normalizeBaseUrl(elBase.value);

  const idx = await fetch(base + "index.json").then(r => r.json());
  indexData = idx.entries;
  rewardEntries = indexData.filter(e => e.category === "rewards");

  renderIndex();
}

function renderIndex() {
  elRows.innerHTML = indexData.map(e => `
    <tr data-id="${e.id}">
      <td><code>${e.id}</code></td>
      <td>${e.category}</td>
      <td>${e.name}</td>
    </tr>
  `).join("");

  elRows.querySelectorAll("tr").forEach(tr => {
    tr.onclick = () => selectPreset(tr.dataset.id);
  });
}

/* ---------------- selection ---------------- */

async function selectPreset(id) {
  const base = normalizeBaseUrl(elBase.value);
  selected = indexData.find(e => e.id === id);
  selectedMeta = await fetch(base + selected.metaPath).then(r => r.json());

  elSelTitle.textContent = selected.name;
  placeholderValues = {};

  buildPlaceholderForm();
  buildAddonRewards();
  rebuild();
}

function buildPlaceholderForm() {
  const ph = selectedMeta.placeholders || {};
  elForm.innerHTML = "";

  for (const [k, spec] of Object.entries(ph)) {
    const isMultiline = k === "commands" || k === "messages";
    const el = document.createElement(isMultiline ? "textarea" : "input");
    el.value = spec.default ?? "";
    el.rows = isMultiline ? 4 : 1;
    el.oninput = () => {
      placeholderValues[k] = el.value;
      rebuild();
    };

    placeholderValues[k] = el.value;

    const wrap = document.createElement("label");
    wrap.innerHTML = `<strong>${spec.label || k}</strong>`;
    wrap.appendChild(el);
    elForm.appendChild(wrap);
  }
}

function buildAddonRewards() {
  elAddRewards.innerHTML = rewardEntries.map(e =>
    `<option value="${e.id}">${e.name}</option>`
  ).join("");

  elAddRewards.onchange = rebuild;
}

/* ---------------- build YAML ---------------- */

async function loadFragments(meta) {
  const base = normalizeBaseUrl(elBase.value);
  const out = [];
  for (const f of meta.fragments) {
    const text = await fetch(base + f.path).then(r => r.text());
    out.push({ mergeInto: f.mergeInto, text });
  }
  return out;
}

async function rebuild() {
  if (!selectedMeta) return;

  const base = normalizeBaseUrl(elBase.value);
  let frags = [];

  // main preset
  const mainFrags = await loadFragments(selectedMeta);
  frags.push(...mainFrags);

  // reward add-ons
  for (const opt of elAddRewards.selectedOptions) {
    const meta = await fetch(base + rewardEntries.find(r => r.id === opt.value).metaPath).then(r => r.json());
    frags.push(...await loadFragments(meta));
  }

  // derived blocks
  const derived = { ...placeholderValues };
  if (derived.commands) derived.commandsBlock = toYamlListBlock(derived.commands, 4);
  if (derived.messages) derived.messagesBlock = toYamlListBlock(derived.messages, 4);

  const grouped = {};
  for (const f of frags) {
    const filled = applyPlaceholders(f.text, derived).trim();
    if (!grouped[f.mergeInto]) grouped[f.mergeInto] = [];
    grouped[f.mergeInto].push(filled);
  }

  const out = [];
  if (grouped.VoteSites) out.push(sectionWrap("VoteSites", grouped.VoteSites.join("\n\n")));
  if (grouped.Rewards) out.push(sectionWrap("Rewards", grouped.Rewards.join("\n\n")));
  if (grouped.VoteMilestones) out.push(sectionWrap("VoteMilestones", grouped.VoteMilestones.join("\n\n")));

  elMerged.textContent = out.join("\n\n") || "Nothing to output.";
  elCopy.disabled = false;
}

/* ---------------- copy ---------------- */

elCopy.onclick = () => {
  navigator.clipboard.writeText(elMerged.textContent);
  elCopy.textContent = "Copied!";
  setTimeout(() => elCopy.textContent = "Copy", 1000);
};

document.getElementById("reloadBtn").onclick = loadIndex;
loadIndex();
</script>

</body>
</html>
