<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VotingPlugin Presets</title>

<style>
body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 18px; }
header { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
input, select, button, textarea { padding: 8px 10px; font-size: 14px; }
textarea { resize: vertical; }
button { cursor: pointer; }
.muted { color:#666; }
.error { color:#b00020; }
.layout { display:grid; grid-template-columns: 1.1fr 1fr; gap:14px; margin-top:14px; }
.card { border:1px solid #e6e6e6; border-radius:12px; padding:12px; background:#fff; }
.row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; }
code { background:#f5f5f5; padding:2px 6px; border-radius:6px; }
pre { background:#0b1020; color:#d6e1ff; padding:12px; border-radius:10px; overflow:auto; max-height:520px; }
table { width:100%; border-collapse: collapse; }
th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; vertical-align:top; }
th { background:#fafafa; position: sticky; top: 0; }
.split { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
.list { max-height:420px; overflow:auto; }
label { display:flex; flex-direction:column; gap:4px; margin-bottom:10px; }
.subcard { border:1px solid #eee; border-radius:10px; padding:10px; background:#fcfcfc; margin-top:10px; }
.hint { font-size:12px; color:#666; margin-top:4px; }
</style>
</head>

<body>

<header>
  <h2 style="margin:0;">VotingPlugin Presets</h2>
  <button id="reloadBtn">Reload</button>
  <span id="status" class="muted"></span>
</header>

<div class="row" style="margin-top:10px;">
  <input id="q" size="34" placeholder="Search presets..." />
  <select id="cat">
    <option value="">All</option>
    <option value="votesites">VoteSites</option>
    <option value="rewards">Rewards</option>
    <option value="milestones">VoteMilestones</option>
  </select>
  <span class="muted" id="count"></span>
</div>

<div id="msg" class="error" style="margin-top:10px;"></div>

<div class="layout">

<!-- LEFT -->
<div class="card">
  <div class="pill">Presets</div>
  <div class="list" style="margin-top:8px;">
    <table>
      <thead>
        <tr>
          <th style="width:30%;">ID</th>
          <th style="width:18%;">Category</th>
          <th>Name</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<!-- RIGHT -->
<div class="card">
  <div class="row" style="justify-content:space-between;">
    <div>
      <div class="pill">Merged YAML</div>
      <div id="selTitle" class="muted">None</div>
    </div>
    <button id="copyBtn" disabled>Copy</button>
  </div>

  <div id="yamlStatus" class="error" style="margin-top:10px; display:none;"></div>
  <pre id="mergedOut" style="margin-top:10px;">Select a VoteSite preset.</pre>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>

<script>
/* =====================================================
   MODE DETECTION (HTTP vs file://)
   ===================================================== */
const isFileMode = location.protocol === "file:";
let rootDirHandle = null;

/* =====================================================
   FILE ACCESS (file:// only)
   ===================================================== */
async function pickRootFolder() {
  rootDirHandle = await window.showDirectoryPicker();
}

async function readLocalFile(path) {
  if (!rootDirHandle) await pickRootFolder();

  const parts = path.split("/").filter(Boolean);
  let dir = rootDirHandle;

  for (let i = 0; i < parts.length - 1; i++) {
    dir = await dir.getDirectoryHandle(parts[i]);
  }

  const file = await (await dir.getFileHandle(parts.at(-1))).getFile();
  return file.text();
}

/* =====================================================
   FETCH ABSTRACTION
   ===================================================== */
async function fetchText(path) {
  if (isFileMode) return readLocalFile(path);

  const r = await fetch(path, { cache: "no-store" });
  if (!r.ok) throw new Error(`HTTP ${r.status} for ${path}`);
  return r.text();
}

async function fetchJson(path) {
  return JSON.parse(await fetchText(path));
}

/* =====================================================
   YAML VALIDATION (silent unless error)
   ===================================================== */
const elYamlStatus = document.getElementById("yamlStatus");

function clearYamlError() {
  elYamlStatus.style.display = "none";
  elYamlStatus.textContent = "";
}

function showYamlError(msg) {
  elYamlStatus.style.display = "block";
  elYamlStatus.textContent = msg;
}

function shouldValidateYaml(text) {
  const s = String(text || "").trim();
  return s.includes(":") || s.startsWith("- ");
}

function validateYaml(text) {
  if (!window.jsyaml || !shouldValidateYaml(text)) {
    clearYamlError();
    return true;
  }
  try {
    jsyaml.load(text);
    clearYamlError();
    return true;
  } catch (e) {
    const l = e?.mark?.line;
    const c = e?.mark?.column;
    const loc = (l != null && c != null) ? ` (line ${l+1}, col ${c+1})` : "";
    showYamlError(`Invalid YAML${loc}: ${e.message}`);
    return false;
  }
}

/* =====================================================
   STATE
   ===================================================== */
let indexData = [];

const elRows = document.getElementById("rows");
const elMerged = document.getElementById("mergedOut");
const elCopy = document.getElementById("copyBtn");
const elSelTitle = document.getElementById("selTitle");
const elQ = document.getElementById("q");
const elCat = document.getElementById("cat");
const elCount = document.getElementById("count");
const elMsg = document.getElementById("msg");
const elStatus = document.getElementById("status");

/* =====================================================
   LOAD INDEX
   ===================================================== */
async function loadIndex() {
  elMsg.textContent = "";
  elStatus.textContent = isFileMode ? "Local file mode – select preset folder" : "Loading…";

  try {
    indexData = (await fetchJson("index.json")).entries || [];
    renderIndex();
    elStatus.textContent = `Loaded ${indexData.length} presets`;
  } catch (e) {
    elMsg.textContent = e.message || String(e);
  }
}

/* =====================================================
   FILTERING
   ===================================================== */
function norm(s) { return String(s||"").toLowerCase().trim(); }

function filteredEntries() {
  const q = norm(elQ.value);
  const c = norm(elCat.value);

  let list = indexData.slice();
  if (c) list = list.filter(e => norm(e.category) === c);
  if (q) {
    list = list.filter(e =>
      [e.id, e.category, e.name, ...(e.keywords||[])]
        .map(norm).join(" ").includes(q)
    );
  }
  elCount.textContent = `${list.length} shown / ${indexData.length} total`;
  return list;
}

function renderIndex() {
  const list = filteredEntries();
  elRows.innerHTML = list.map(e => `
    <tr>
      <td><code>${e.id}</code></td>
      <td>${e.category}</td>
      <td>${e.name}</td>
    </tr>
  `).join("");
}

/* =====================================================
   EVENTS
   ===================================================== */
document.getElementById("reloadBtn").onclick = loadIndex;
elQ.oninput = renderIndex;
elCat.onchange = renderIndex;

elCopy.onclick = async () => {
  await navigator.clipboard.writeText(elMerged.textContent);
  elCopy.textContent = "Copied!";
  setTimeout(() => elCopy.textContent = "Copy", 800);
};

loadIndex();
</script>

</body>
</html>
