name: Generate preset PR from issue

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  generate:
    if: contains(github.event.issue.labels.*.name, 'preset-request')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Determine preset kind
        id: kind
        run: |
          labels='${{ toJson(github.event.issue.labels.*.name) }}'
          echo "Labels: $labels"
          if echo "$labels" | grep -qi '"reward"'; then
            echo "PRESET_KIND=reward" >> $GITHUB_OUTPUT
          else
            echo "PRESET_KIND=votesite" >> $GITHUB_OUTPUT
          fi

      - name: Generate files
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          PRESET_KIND: ${{ steps.kind.outputs.PRESET_KIND }}
        run: |
          node tools/generate-preset-from-issue.mjs

      - name: Create PR
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const branch = `preset/issue-${issue.number}`;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Create branch from default branch
            const { data: repoInfo } = await github.rest.repos.get({ owner, repo });
            const defaultBranch = repoInfo.default_branch;

            const { data: ref } = await github.rest.git.getRef({
              owner, repo, ref: `heads/${defaultBranch}`
            });

            try {
              await github.rest.git.createRef({
                owner, repo, ref: `refs/heads/${branch}`, sha: ref.object.sha
              });
            } catch (e) {
              // branch may already exist
            }

            // Commit changes using git in workflow (simpler): weâ€™ll just push with CLI here.
            // github-script step only creates PR assuming branch was pushed.

            core.setOutput("branch", branch);

      - name: Commit & push changes
        run: |
          BRANCH="preset/issue-${{ github.event.issue.number }}"
          git checkout -B "$BRANCH"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "chore: generate preset(s) from issue #${{ github.event.issue.number }}"
          git push -u origin "$BRANCH" --force

      - name: Open PR
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = `preset/issue-${issue.number}`;

            // See if PR already exists
            const prs = await github.rest.pulls.list({
              owner, repo, state: "open", head: `${owner}:${branch}`
            });
            if (prs.data.length) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: issue.number,
                body: `PR already exists: #${prs.data[0].number}`
              });
              return;
            }

            const { data: repoInfo } = await github.rest.repos.get({ owner, repo });
            const base = repoInfo.default_branch;

            const pr = await github.rest.pulls.create({
              owner, repo,
              title: `Generate preset(s) from issue #${issue.number}`,
              head: branch,
              base,
              body: `Auto-generated from issue #${issue.number}.\n\nPlease review the preset defaults and domains.`
            });

            await github.rest.issues.createComment({
              owner, repo, issue_number: issue.number,
              body: `Opened PR: #${pr.data.number}`
            });
